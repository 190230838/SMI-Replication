---
title: "SMI 205 Replication Project"
author: "190230838"
date: "5/20/2021"
output: html_document
---

# SMI 205 Replication Project


### Workspace setup
```{r echo=TRUE, warning=FALSE, error=FALSE, message=FALSE}
library(dplyr)
library(haven)
library(foreign)
library(xfun)
library(htmltools)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(ggplot2)
library(coefplot)
library(gridExtra)
```


# Introduction 




#### Loading datasets

```{r echo=TRUE, results='hide'}
bes2017<-read.dta("bes_f2f_2017_v1.5.dta")

bes2019<-read_dta("bes_rps_2019_1.0.0.dta")

```






#### Dummy coding twitter variable 

```{r echo=TRUE, results='hide'}

bes2017$twitter[bes2017$k06 == "Yes"]<-1
bes2017$twitter[bes2017$k06 == "Don`t know"]<-NA
bes2017$twitter[bes2017$k06 == "No"]<-0



bes2019$twitter[bes2019$k06 == 1]<-1
bes2019$twitter[bes2019$k06 == -1]<-NA
bes2019$twitter[bes2019$k06 == 2]<-0



```


#### Dummy coding FB variable

```{r echo=TRUE, results='hide'}
bes2017$FB[bes2017$k08 == "No"]<-0
bes2017$FB[bes2017$k08 == "Yes"]<-1
bes2017$FB[bes2017$k08 == "Don`t know"]<-NA


bes2019$FB[bes2019$k08 == -1]<-NA
bes2019$FB[bes2019$k08 == 1]<-1
bes2019$FB[bes2019$k08 == 2]<-0

```


####  Recoding education variable

```{r, echo=TRUE, results='hide'}

bes2017<-bes2017%>% mutate(
  EducationLevel = case_when(
    education == "No qualification" ~ "no qualifications",
    education == "GCSE D-G, CSE grades 2-5, O level D-E"|
      education == "Youth training certificate, skill seekers"|
      education == "Clerical and commercial qualifications"~ "GCSE D-G",
    education == "GCSE A*-C, CSE grade 1, O level grade A-C"|
      education == "Scottish Standard grades, Ordinary bands"|
      education == "Recognised trade apprenticeship"|
      education == "City&Guilds level 1, NVQ/SVQ 1 and equivalent"~"GCSE A*-C",
    education == "A level or equivalent"|
      education == "Scottish Higher or equivalent"|
      education == "City&Guilds level 2, NVQ/SVQ 2 and equivalent"|
      education == "HNC/HND, City&Guilds level 4, NVQ/SVQ 4/5"|
      education == "ONC/OND, City&Guilds level 3, NVQ/SVQ 3"~ "A level",
    education == "Univ/poly diploma"|
      education == "First degree"|
      education == "Nursing qualification"|
      education == "Teaching qualification" ~ "Undergraduate",
    education == "Postgraduate degree"~ "Postgraduate",
    education == "Other technical, professional or higher qualification"|
      education == "AAT/ACA/ Accountancy qualifications"|
      education == "hgv" |
      education == "Refused" ~ "Other"))

bes2017$EducationLevel[bes2017$EducationLevel == "Other"]<-NA
bes2017$EducationLevel<-as.factor(bes2017$EducationLevel)
bes2017$EducationLevel<-factor(bes2017$EducationLevel, levels = c("no qualifications",
                                                          "GCSE D-G",
                                                          "GCSE A*-C",
                                                          "A level",
                                                          "Undergraduate",
                                                          "Postgraduate"))


bes2019<-bes2019%>% mutate(
  EducationLevel = case_when(
    education == 0 ~ "no qualifications",
    education == 12|
      education == 17|
      education == 15 ~ "GCSE D-G",
    education == 10|
      education == 11|
      education == 16|
      education == 14 ~ "GCSE A*-C",
    education == 7|
      education == 8|
      education == 13|
      education == 6|
      education == 9~ "A level",
    education == 3|
      education == 2|
      education == 5|
      education == 4 ~ "Undergraduate",
    education == 1 ~ "Postgraduate",
    education == 18|
      education == 19|
      education == -2 |
      education == -1 ~ "Other"))


bes2019$EducationLevel[bes2019$EducationLevel == "Other"]<-NA
bes2019$EducationLevel<-as.factor(bes2019$EducationLevel)
bes2019$EducationLevel<-factor(bes2019$EducationLevel, levels = c("no qualifications",
                                                          "GCSE D-G",
                                                          "GCSE A*-C",
                                                          "A level",
                                                          "Undergraduate",
                                                          "Postgraduate"))

```



#### Dummy coding gender variable 


```{r echo=TRUE, results='hide'}
bes2017$gender = 0
bes2017$gender[bes2017$y09 == "Female"]<-1

bes2019$gender[bes2019$y09 == 1]<-0
bes2019$gender[bes2019$y09 == 2]<-1
bes2019$gender[bes2019$y09 == 3]<-NA
bes2019$gender[bes2019$y09 == 4]<-NA
```


#### Remove missing age 
```{r}
bes2017$Age[bes2017$Age == -1]<-NA
bes2017$Age[bes2017$Age == -2]<-NA

bes2019$Age[bes2019$Age == -999]<-NA
bes2019$Age[bes2019$Age == -2]<-NA
```




#### Income with nonresponse category


```{r echo=TRUE, results='hide'}

table(bes2017$y01)
bes2017<-bes2017%>% mutate(
  IncomeNonresp = case_when(
    y01 == "Refused"|y01 == "Don`t know" ~ "Nonresponse",
    y01 == "Under GBP 2,600"|y01 == "GBP 2,600 - GBP 5,199" ~ "Under £5,200",
    y01 == "GBP 5,200 - GBP 10,399"| y01 == "GBP 10,400 - GBP 15,599"| y01 == "GBP 15,600 - GBP 20,799"| y01 == "GBP 20,800 - GBP 25,999"~ "£5,200 - £25,999",
   y01 == "GBP 26,000 - GBP 31,199"|y01 == "GBP 31,200 - GBP 36,399"|y01== "GBP 36,400 - GBP 39,999"|y01== "GBP 40,000 - GBP 44,999" ~ "£26,000 - £44,999",
    y01 == "GBP 45,000 - GBP 49,999"| y01 =="GBP 50,000 - GBP 59,999"| y01 == "GBP 60,000 - GBP 74,999"|y01 == "GBP 75,000 - GBP 99,999" ~ "£45,000 - £99,999",
  y01=="GBP 100,000 or more"~"£100,000 or more"))
    
bes2017$IncomeNonresp<-as.factor(bes2017$IncomeNonresp) 

bes2017$IncomeNonresp<-factor(bes2017$IncomeNonresp, levels = c("Under £5,200",
                                                                "£5,200 - £25,999",
                                                                "£26,000 - £44,999",
                                                                  "£45,000 - £99,999",
                                                                "£100,000 or more",
                                                                "Nonresponse"))
                                                              

table(bes2019$y01_Annual)
bes2019<-bes2019%>%mutate(
  IncomeNonresp = case_when(
    y01_Annual == -999|y01_Annual == -2|y01_Annual == -1 ~ "Nonresponse",
    y01_Annual == 1 ~ "Under£5,200",
    y01_Annual == 2|y01_Annual == 3 ~ "£5200-£25,999",
    y01_Annual == 4|y01_Annual == 5 ~ "£26,000 - £46,799",
    y01_Annual == 6|y01_Annual == 7 ~ "£46,800 - £149,999",
    y01_Annual == 8 ~ "£150,000 or more"))
bes2019$IncomeNonresp<-as.factor(bes2019$IncomeNonresp)
bes2019$IncomeNonresp<-factor(bes2019$IncomeNonresp, levels = c("Under£5,200",
                                                                "£5200-£25,999",
                                                                "£26,000 - £46,799",
                                                                "£46,800 - £149,999",
                                                                "£150,000 or more",
                                                                "Nonresponse"))



```



#### EU vote variable


```{r echo=TRUE, results='hide'}
bes2017$EUleave = 0
bes2017$EUleave[bes2017$p01 == "Leave the EU"]<-1
bes2017$EUleave[bes2017$p01 == "Don`t know"]<-NA
bes2017$EUleave[bes2017$p01 == "I did not vote"]<-NA


bes2019$EUleave = 0
bes2019$EUleave[bes2019$p01 == 2]<-1
bes2019$EUleave[bes2019$p01 == -1]<-NA
bes2019$EUleave[bes2019$p01 == 1]<-NA
bes2019$EUleave[bes2019$p01 == -999]<-NA


```



#### Recode political attention variable


```{r echo=TRUE, results='hide', warning=FALSE}

bes2017$polattention = bes2017$k01
bes2017$polattention[bes2017$polattention == "Don't know"]<-NA
bes2017$polattention[bes2017$polattention == "Pay no attention"]<-0
bes2017$polattention[bes2017$polattention == "Pay a great deal of attention"]<-10
bes2017$polattention[bes2017$polattention == "Don`t know"]<-NA
bes2017$polattention[bes2017$polattention == "Not stated"]<-NA
bes2017$polattention<-as.numeric(bes2017$polattention)

bes2019$k01[bes2019$k01 == -999]<-NA
bes2019$k01[bes2019$k01 == -1]<-NA
bes2019$polattention = bes2019$k01
bes2019$polattention <- as.numeric(bes2019$polattention)

```




#####  Creating new dataset with variables


```{r}

bes17 = subset(bes2017, select = c(twitter, FB, EducationLevel, gender, Age, polattention, IncomeNonresp,EUleave,wt_demog))


bes19 = subset(bes2019, select = c(twitter, FB, EducationLevel, gender, Age, polattention, IncomeNonresp,EUleave, wt_demog,finalserialno))


```


### Summary Statistics


#####  Age distribution of respondents
```{r}

hist(bes17$Age, col = "blue", border = "grey",
     main="Figure 1. Age distribution of respondents", xlab="Age", xlim=c(15,100))


```



##### Income of respondents

```{r}

income_table17<-round(rbind(table(bes17$IncomeNonresp),
                          prop.table(table(bes17$IncomeNonresp)),
                          prop.table(table(bes17$IncomeNonresp))*100),2)
rownames(income_table17) <- c("Count",                   
                          "Proportion",
                          "Percentage")

income_table19<-round(rbind(table(bes19$IncomeNonresp),
                          prop.table(table(bes19$IncomeNonresp)),
                          prop.table(table(bes19$IncomeNonresp))*100),2)

rownames(income_table19) <- c("Count",                   
                          "Proportion",
                          "Percentage")

income_table17
income_table19




```














#


### Representativeness of social media users (2017)

```{r echo=FALSE, warning=FALSE, message=FALSE}

labelDataset <- function(data) {
   correctLabel <- function(x) {
     if(!is.null(attributes(x)$labels)) {
       class(attributes(x)$labels) <- typeof(x)
     }
     return(x)
   }
   for(i in colnames(data)) {
     data[, i] <- correctLabel(data[, i])
   }
   return(data)
 }

bes2017$twitterUse=bes2017$twitter
bes2017$fbUse=bes2017$FB

bes <- labelDataset(bes2017)
bes$Age[bes$Age < 18] <- NA

bes$twitterUse <- as.character(bes$twitterUse)
bes$twitterUse[bes$twitterUse=="0"] <- "No"
bes$twitterUse[bes$twitterUse=="1"] <- "Yes"
bes$twitterUse[bes$twitterUse=="Don't know"] <- NA
bes$fbUse <- as.character(bes$fbUse)
bes$fbUse[bes$fbUse=="0"] <- "No"
bes$fbUse[bes$fbUse=="1"] <- "Yes"
bes$fbUse[bes$fbUse=="Don't know"] <- NA

bes$Age <- as.numeric(bes$Age)

bes.2 <- bes
bes.2$twitterUse <- "Population"

bes.2$fbUse <- "Population"
bes.1 <- bes
bes <- rbind(bes.1, bes.2)
bes$twitterUse[which(bes$twitterUse=="Yes")] <- "Twitter user"
bes$twitterUse[which(bes$twitterUse=="No")] <- "Non-user"
bes$twitterUse <- factor(bes$twitterUse, levels = c("Population",
                                                    "Twitter user", "Non-user"))

bes$fbUse[which(bes$fbUse=="Yes")] <- "Facebook user"
bes$fbUse[which(bes$fbUse=="No")] <- "Non-user"
bes$fbUse <- factor(bes$fbUse, levels = c("Population",
                                          "Facebook user", "Non-user"))

bes$polattention[bes$polattention=="Don't know"] <- NA

bes$Group <- bes$twitterUse
bes$gender <- as.character(bes$gender)
bes$gender[bes$gender=="1"] <- "Female"
bes$gender[bes$gender=="0"] <- "Male"



xBySoc <- function(xvar, socMedia, formula) {
  library(survey)
  bes.design <- svydesign(id = bes$finalserialno, 
                          weights = bes$wt_demog,
                          data = bes<-subset(bes,!is.na(wt_demog)))
  ed.sm <- prop.table(svytable(design = bes.design, 
                                    formula = formula), 1)
  
  library(reshape)
  ed.sm <- melt(ed.sm)
  colnames(ed.sm) <- c("Group", "xvar", "prop")
  ed.sm$xvar <- factor(ed.sm$xvar, levels = unique(ed.sm$xvar))
  ed.sm$Group <- factor(ed.sm$Group, levels = unique(ed.sm$Group))
  
  bar.plot <- ggplot(ed.sm, aes(x = xvar, y = prop, group = Group, fill = Group)) + 
    geom_bar(stat = "identity", position = "dodge", colour = "black", width = 0.75) + theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ylab("Proportion")
  return(bar.plot)
}


gender.twitter.17 <- xBySoc(xvar = "gender", socMedia = "twitterUse",
                         formula = ~twitterUse + gender) + xlab("Gender")
gender.fb.17 <- xBySoc(xvar = "gender", socMedia = "fbUse",
                    formula = ~fbUse + gender) + xlab("Gender")


ed.twitter.17 <- xBySoc(xvar = "EducationLevel", socMedia = "twitterUse", 
       formula = ~twitterUse + EducationLevel) + xlab("Education")
ed.fb.17 <- xBySoc(xvar = "EducationLevel", socMedia = "fbUse", 
       formula = ~fbUse + EducationLevel) + xlab("Education")


income.twitter.17 <- xBySoc(xvar = "IncomeNonresp", socMedia = "twitterUse", 
                     formula = ~twitterUse + IncomeNonresp) + xlab("Income")
income.fb.17 <- xBySoc(xvar = "IncomeNonresp", socMedia = "fbUse", 
                formula = ~fbUse + IncomeNonresp) + xlab("Income")


```




#### Age 


```{r}
mean(bes17$Age, na.rm = TRUE)                    ### Mean age of entire population
mean(bes17$Age[bes17$twitter ==1], na.rm = TRUE) ### Mean age of twitter users
mean(bes17$Age[bes17$twitter == 0], na.rm = TRUE)### Mean age of twitter non users

mean(bes17$Age[bes17$FB==1], na.rm = TRUE)       ### Mean age of facebook users
mean(bes17$Age[bes17$FB==0], na.rm = TRUE)       ### Mean age of facebook non users


```







#### Gender, education and income



```{r, echo=FALSE}
grid.arrange(gender.fb.17, gender.twitter.17,
             ed.fb.17, ed.twitter.17)

grid.arrange(income.fb.17,income.twitter.17)
```
Based on Mellon and Prosser(2017)









### Representativeness of social media users (2019)
```{r,echo=FALSE, warning=FALSE, message=FALSE}


bes2019$twitterUse[bes2019$twitter=="0"] <- "No"
bes2019$twitterUse[bes2019$twitter=="1"] <- "Yes"
bes2019$twitterUse[bes2019$twitter=="Don't know"] <- NA

bes2019$fbUse[bes2019$FB=="0"] <- "No"
bes2019$fbUse[bes2019$FB=="1"] <- "Yes"
bes2019$fbUse[bes2019$FB=="Don't know"] <- NA
bes2019$Age<-as.numeric(bes2019$Age)

bes2019$twitterUse <- as.character(bes2019$twitterUse)
bes2019$fbUse <- as.character(bes2019$fbUse)

bes19$twitterUse = bes2019$twitterUse
bes19$fbUse = bes2019$fbUse


bes.a<-bes19
bes.a$twitterUse<-"Population"
bes.a$fbUse<-"Population"
bes.b<-bes19
bes.c<-rbind(bes.a,e=bes.b)

bes.c$twitterUse[which(bes.c$twitterUse=="Yes")] <- "Twitter user"
bes.c$twitterUse[which(bes.c$twitterUse=="No")] <- "Non-user"
bes.c$twitterUse <- factor(bes.c$twitterUse, levels = c("Population",
                                                    "Twitter user", "Non-user"))

bes.c$fbUse[which(bes.c$fbUse=="Yes")] <- "Facebook user"
bes.c$fbUse[which(bes.c$fbUse=="No")] <- "Non-user"
bes.c$fbUse <- factor(bes.c$fbUse, levels = c("Population",
                                          "Facebook user", "Non-user"))


bes.c$Group <- bes.c$twitterUse
bes.c$gender <- as.character(bes.c$gender)
bes.c$gender[bes.c$gender=="1"] <- "Female"
bes.c$gender[bes.c$gender=="0"] <- "Male"




xBySoc.c <- function(xvar, socMedia, formula) {
  library(survey)
  bes.design <- svydesign(id = bes.c$finalserialno, 
                          weights = bes.c$wt_demog,
                          data = bes.c<-subset(bes.c,!is.na(wt_demog)))
  ed.sm <- prop.table(svytable(design = bes.design, 
                                    formula = formula), 1)
  
  library(reshape)
  ed.sm <- melt(ed.sm)
  colnames(ed.sm) <- c("Group", "xvar", "prop")
  ed.sm$xvar <- factor(ed.sm$xvar, levels = unique(ed.sm$xvar))
  ed.sm$Group <- factor(ed.sm$Group, levels = unique(ed.sm$Group))
  
  bar.plot <- ggplot(ed.sm, aes(x = xvar, y = prop, group = Group, fill = Group)) + 
    geom_bar(stat = "identity", position = "dodge", colour = "black", width = 0.75) + theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ylab("Proportion")
  return(bar.plot)
}


gender.twitter.19 <- xBySoc.c(xvar = "gender", socMedia = "twitterUse",
                         formula = ~twitterUse + gender) + xlab("Gender")
gender.fb.19<-xBySoc.c(xvar = "gender", socMedia = "fbUse",
                         formula = ~fbUse + gender) + xlab("Gender")



ed.twitter.19 <- xBySoc.c(xvar = "EducationLevel", socMedia = "twitterUse", 
       formula = ~twitterUse + EducationLevel) + xlab("Education")
ed.fb.19 <- xBySoc.c(xvar = "EducationLevel", socMedia = "fbUse", 
       formula = ~fbUse + EducationLevel) + xlab("Education")


income.twitter.19 <- xBySoc.c(xvar = "IncomeNonresp", socMedia = "twitterUse", 
                     formula = ~twitterUse + IncomeNonresp) + xlab("Income")
income.fb.19 <- xBySoc.c(xvar = "IncomeNonresp", socMedia = "fbUse", 
                formula = ~fbUse + IncomeNonresp) + xlab("Income")





```



#### Age


```{r}

mean(bes19$Age, na.rm = TRUE)                       ### Mean age of entire population

mean(bes19$Age[bes19$twitter ==1], na.rm = TRUE)    ### Mean age of twitter users
mean(bes19$Age[bes19$twitter == 0], na.rm = TRUE)   ### Mean age of twitter non users

mean(bes19$Age[bes19$FB==1], na.rm = TRUE)          ### Mean age of facebook users
mean(bes19$Age[bes19$FB==0], na.rm = TRUE)          ### Mean age of facebook non users


```







```{r}

grid.arrange(gender.fb.19,gender.twitter.19,
             ed.fb.19, ed.twitter.19)

grid.arrange(income.fb.19,income.twitter.19)

```












 


### OLS Regression models 

#### 2017 models
```{r echo=TRUE, results='hide'}

### Facebook models
polattFB17.1<-lm(data =subset(bes17, FB = 1),polattention~Age+gender+EducationLevel+FB, weights = wt_demog)   ## Original variables
polattFB17.2<-lm(data = subset(bes17, FB = 1),polattention~Age+gender+EducationLevel+IncomeNonresp+FB,weights = wt_demog) ## Added income variable
polattFB17.3<-lm(data = subset(bes17, FB = 1),polattention~Age+gender+EducationLevel+EUleave+FB,weights = wt_demog) ## Added EU variable
polattFB17.4<-lm(data = subset(bes17,FB=1),polattention~Age+gender+EducationLevel+IncomeNonresp+EUleave+FB,weights = wt_demog)## Added both EU and income

### Twitter models
polatttwitter17.1<-lm(data = subset(bes17,twitter=1),polattention~Age+gender+EducationLevel+twitter,weights = wt_demog) ## Original variables
polatttwitter17.2<-lm(data =subset(bes17,twitter=1),polattention~Age+gender+EducationLevel+IncomeNonresp+twitter,weights = wt_demog) ## Added income
polatttwitter17.3<-lm(data = subset(bes17,twitter=1),polattention~Age+gender+EducationLevel+EUleave+twitter,weights=wt_demog) ## Added EU
polatttwitter17.4<-lm(data = subset(bes17,twitter=1),polattention~Age+gender+EducationLevel+IncomeNonresp+ EUleave+twitter,weights=wt_demog)## Both income and EU 
```


#### 2019 models
```{r}

### Facebook models
polattFB19.1<-lm(data = subset(bes19,FB=1),polattention~Age+gender+EducationLevel+FB, weights = wt_demog) ## Original variables
polattFB19.2<-lm(data = subset(bes19,FB=1),polattention~Age+gender+EducationLevel+IncomeNonresp+FB, weights = wt_demog) ## Income variable
polattFB19.3<-lm(data = subset(bes19,FB=1),polattention~Age+gender+EducationLevel+EUleave+FB, weights = wt_demog)## EU variable
polattFB19.4<-lm(data = subset(bes19,FB=1),polattention~Age+gender+EducationLevel+IncomeNonresp+EUleave+FB,weights = wt_demog)## Both income and EU 

### Twitter models
polatttwitter19.1<-lm(data = subset(bes19,twitter=1),polattention~Age+gender+EducationLevel+twitter, weights = wt_demog)## Original variables
polatttwitter19.2<-lm(data = subset(bes19,twitter=1),polattention~Age+gender+EducationLevel+IncomeNonresp+twitter, weights = wt_demog)## Income variable
polatttwitter19.3<-lm(data = subset(bes19,twitter=1),polattention~Age+gender+EducationLevel+EUleave+twitter,weights = wt_demog)## EU variable
polatttwitter19.4<-lm(data = subset(bes19,twitter=1),polattention~Age+gender+EducationLevel+IncomeNonresp+EUleave+twitter,weights = wt_demog)## Both income and EU 

```




#### 2017 OLS output
```{r}
tab_model(polattFB17.4,polatttwitter17.4,pred.labels = c("Intercept", "Age", "Female","Education GCSE D-G","GCSE A*-C","A Level","Undergraduate","Postgraduate","Income £5,200-£25,999", "£26,000-£44,999","£45,000-£99,999","£100,000 or more","Income Nonresponse", "Voted Leave","Uses social network","Uses social network"),dv.labels = c("Facebook","Twitter"),
          string.est = "Coefficient",
          string.ci = "Conf.Int (95%)",
          string.p = "P-Value")

```




#### 2019 OLS output
```{r}
tab_model(polattFB19.4, polatttwitter19.4,
          pred.labels = c("Intercept", "Age", "Female","Education GCSE D-G","GCSE A*-C","A Level",
                          "Undergraduate","Postgraduate","Income £5,200-£25,999", "£26,000-£44,999","£45,000-£99,999","£100,000 or more","Income Nonresponse", "Voted Leave","Uses social network","Uses social network"),dv.labels = c("Facebook","Twitter"),
          string.est = "Coefficient",
          string.ci = "Conf.Int (95%)",
          string.p = "P-Value")

```













